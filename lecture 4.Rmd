---
title: "**`R Code for Lecture 4`**"
output: html_document
---

***

```{r, message = F, warning = F}
library(TSA)
library(latex2exp)
library(ggplot2)
```

### Random Walks

***

```{r}
# simulating random walk
e <- rnorm(200, 0, 1/2)
Xt <- cumsum(e)
acf(Xt)
rw.data <- data.frame(date = c(1:length(Xt)), Xt = Xt)
fig1 <- ggplot(rw.data, aes(date)) + 
  geom_line(aes(y = Xt), size = 0.6, color = "seagreen4") +
  labs(title = "Random Walks", 
       x = "Dates", y = TeX("$X_t$")) +        
  theme(axis.title = element_text(family = "serif"),
        plot.title = element_text(hjust = 0.5, family = "serif", face = "bold"))
fig1
```

### ARIMA(0,1,1)

***

```{r, message = F, warning = F}
# simulating ARIMA(0,1,1)
X <- arima.sim(list(order = c(0,1,1), ma = 0.5), n = 500)
dX1 <- diff(X, lag = 1)
arima.data <- data.frame(date = c(1:length(X)), Xt = X, dXt = c(NA, dX1))
acf(arima.data$Xt, na.action = na.pass)
fig21 <- ggplot(arima.data, aes(date)) + 
  geom_line(aes(y = Xt), size = 0.6, color = "dodgerblue3") +
  labs(title = "ARIMA(0,1,1)", 
       x = "Dates", y = TeX("$X_t$")) +        
  theme(axis.title = element_text(family = "serif"),
        plot.title = element_text(hjust = 0.5, family = "serif", face = "bold"))
fig21

acf(arima.data$dXt, na.action = na.pass)
fig22 <- ggplot(arima.data, aes(date)) + 
  geom_line(aes(y = dXt), size = 0.5, color = "darkblue") +
  labs(title = "Differenced ARIMA(0,1,1)", 
       x = "Dates", y = TeX("$\\nabla X_t$")) +        
  theme(axis.title = element_text(family = "serif"),
        plot.title = element_text(hjust = 0.5, family = "serif", face = "bold"))
fig22
```

### Fitting ARMA Models

***

In what follows, we perform a small-scale Monte Carlo experiment (simulation). First, we draw a time series from the following ARMA(3,2) model (data generating process):
\[
X_{t}=\frac{3}{4}X_{t-1}-\frac{1}{2}X_{t-2}+\frac{1}{4}X_{t-3}+\epsilon_{t}+\frac{1}{2}\epsilon_{t-1}-\frac{1}{4}\epsilon_{t-2},\epsilon_{t}\overset{iid}{\sim}Logistic(0,\frac{1}{2})
\]
and then we fit an ARMA(3,2) model using the simulated data and the `arima()` function. 
```{r, message = F}
# draw time series data
# Note: in fact, this can be done more easily using the arima.sim() function
set.seed(1)
e <- numeric(); X <- numeric() 
e[1:3] <- rlogis(3, 0, 1)/2
X[1:3] <- rnorm(3, 0, 1)

T = 1000
for (t in 4:T) {
  et <- rlogis(1, 0, 1)/2
  X[t] = 0.75*X[t-1] - 0.5*X[t-2] + 0.25*X[t-3] + et + 0.5*e[t-1] - 0.25*e[t-2]
  e[t] <- et
}
ts.data <- data.frame(X)
```

```{r}
# LSE
arima.lse <- arima(ts.data, order = c(3, 0, 2), method = "CSS")
arima.lse

# quasi-Gaussian MLE
arima.mle <- arima(ts.data, order = c(3, 0, 2), method = "ML")
arima.mle
```

### Model Diagnostics: Residual Analysis

***

```{r, message = F}
# residual analysis
tsdiag(arima.lse, gof.lag = 10)
tsdiag(arima.mle, gof.lag = 10)

# residual qq-plot
ehat <- data.frame(residuals(arima.lse))

y <- quantile(ehat, c(0.25, 0.75), na.rm = T) 
x <- qnorm(c(0.25, 0.75))         
slope <- diff(y)/diff(x)             
int   <- y[1] - slope*x[1] 
qq <- ggplot(ehat, aes(sample = ehat)) +
  geom_qq(alpha = 0.5, size = 3, color = "dodgerblue3") +
  geom_abline(intercept=int, slope=slope, color = "darkred", size = 1) +
  labs(title = "Q-Q Plot of Residuals", 
       x = "Normal Quantile", y = "Quantile of Residuals") +
  theme(axis.title = element_text(family = "serif"),
        plot.title = element_text(hjust = 0.5, family = "serif"))
print(qq)
```